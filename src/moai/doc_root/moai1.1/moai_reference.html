<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta http-equiv="Content-Style-Type" content="text/css">
	<link href="/msty.css" rel="stylesheet" type="text/css">
</head>
<body>
<a name=TopBar></a>
<p><b><img src="/imgs/here_landmark.png"> Moai1.1ドキュメント</b></p>

<a class=MstyElemLink href="/">トップページ</a> &nbsp;
<a class=MstyElemLink href="/moai2.0/index.html">Moai2.0ドキュメント</a> &nbsp;
<a class=MstyNowSelectedLink href="/moai1.1/index.html">Moai1.1ドキュメント</a> &nbsp;
<br> <br>
<a class=MstyElemLink        href="/moai1.1/install.html">インストールガイド</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/index.html">Moaiの特徴</a> &nbsp;
<a class=MstyNowSelectedLink href="/moai1.1/moai_reference.html">Moaiリファレンス</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/local_proxy.html">ローカルプロキシ</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/FAQ.html">FAQ</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/how_to_compile.html">HowToコンパイル</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/hacking.html">ハッキング</a> &nbsp;
<br> <br>

<div class=MstyComment>
<u><b>記事担当者</b></u> : Mr.Moai ＆ 高速ヤキソバ変換<br> 
<br>
<u><b>最終更新日</b></u> : 2018/03/25<br>
<br>
</div>
<br>

<u><b>はじめに</b></u>
<ul>
	<font >
		Moai Ver1.1.8 はローカルプロキシと呼ばれるツールになります.<br>
		moaiが起動中は、あなたのマシンはローカルなプロキシサーバとして機能します.<br>
		<br>
		<div class=MstyComment>
			<u><b>Note</b></u><br>
			<br>
			デフォルトの設定では安全のため、あなたのマシン以外からのMoaiへの接続はすべて遮断されるようになっています.<br>
		</div>
		<br>
		この記事ではMoaiエンジン本体に関する全機能を詳細に解説します.<br>
	</font><br>
</ul><br>


<a name=Index></a>
<u><b>目次</b></u>
<ul>
	<li><b><a class=MstyElemLink href=#RunMoai>Moaiの起動</a></b></li>
	<li><b><a class=MstyElemLink href=#AsLocalProxy>Moaiをローカルプロキシとして使う</a></b></li>
	<li><b><a class=MstyElemLink href=#target>ターゲットとは？    </a></b></li>
	<li><b><a class=MstyElemLink href=#filter_recv>受信フィルタについて</a></b></li>
	<li><b><a class=MstyElemLink href=#filter_recv_section1>受信フィルタ : html_filter, js_filter, css_filter セクション</a></b></li>
	<li><b><a class=MstyElemLink href=#filter_recv_section2>受信フィルタ : css_additional セクション</a></b></li>
	<li><b><a class=MstyElemLink href=#filter_send>送信フィルタについて</a></b></li>
	<li><b><a class=MstyElemLink href=#filter_send_header_vars>送信フィルタ : header_vars(HTTPヘッダの値の修正)</a></b></li>
	<li><b><a class=MstyElemLink href=#filter_send_post_vars  >送信フィルタ : post_vars(POST変数の値の修正)</a></b></li>
	<li><b><a class=MstyElemLink href=#filter_send_cookie     >送信フィルタ : cookie_vars および cookie_force (Cookieの値の修正)</a></b></li>
	<li><b><a class=MstyElemLink href=#ignore_hosts>無用なホストへの接続をブロックする(ignore_hosts機能)</a></b></li>
	<li><b><a class=MstyElemLink href=#post_confirm>POST時の確認メッセージ表示(post_confirm機能)</a></b></li>
	<li><b><a class=MstyElemLink href=#acceptable_host>他のマシンからの接続を許可/制限する</a></b></li>
	<li><b><a class=MstyElemLink href=#proxy1>外部プロキシを使いたい場合どうするのか？</a></b></li>
	<li><b><a class=MstyElemLink href=#proxy2>外部プロキシの適用を一部のサイトのみに限定する</a></b></li>
	<li><b><a class=MstyElemLink href=#proxy3>その他のローカルプロキシにチェーンする場合</a></b></li>
	<li><b><a class=MstyElemLink href=#web_config>Moai Web Configuration</a></b></li>
	<li><b><a class=MstyElemLink href=#plugin>プラグイン機能について</a></b></li>
	<li><b><a class=MstyElemLink href=#license>ライセンス</a></b></li>
	<li><b><a class=MstyElemLink href=#as_is>免責事項</a></b></li>
</ul><br>


<a name=RunMoai></a>
<u><b>Moaiの起動</b></u>
<ul>
	<font >
		Moaiはサーバプログラムの一種ですから、これを機能させるためにはMoaiを起動しておかなければなりません.<br>
		moai(Windowsならmoai.exe)を実行しましょう.<br>
		(もしインストールがまだならインストールガイドを参照してください)<br>
		これでこのプログラムが実行している間、Moaiはサーバとして機能します.<br>
		<br>
		<div class=MstyComment>
			<u><b>Note</b></u><br>
			<br>
			Moaiが使用(リッスン)するポート番号はデフォルトで8124となります.<br>
			お使いのOSでなんらかのFirewall機能が存在する場合、<br>
			このポートへの接続が行えるよう設定しておく必要があるかもしれません.<br>
		</div>
		<br>
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>


<a name=AsLocalProxy></a>
<u><b>
Moaiをローカルプロキシとして使う
</b></u><br>
<br>
<div class=MstyIndent>
	Moai Ver1.1.8 は<b>ローカルプロキシ</b>と呼ばれるツールです.<br>
	そして Moai のフィルタリング機能によりネット掲示板などで仮想環境を実現するには、<br>
	ブラウザにて「プロキシの設定」を行っておく必要があります.<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0では Moai は<b>ポータブルウェブサーバシステム</b>へと進化しています.<br>
		これにより<b>ブラウザにて特別な設定をすることなく</b>、普通にネットを見る操作のみで仮想環境を利用することができます.<br>
		言い換えれば、<b>ブラウザにて「プロキシの設定」を行っておく必要がなくなりました</b>.<br>
		Moaiが全く初めての方でも、これまでのバージョンと比べはるかに手が付けやすいものとなっています.<br>
	</div>
	<br>
	ローカルプロキシは基本的にどのようなサイトにでも常に機能するという強力さがあります.<br>
	ローカルプロキシとして使う方法の詳細については<a class=MstyElemLink href=/moai1.1/local_proxy.html target=_blank>ローカルプロキシ</a>を参照してください.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=target></a>
<u><b>ターゲットとは？</b></u>
<ul>
	<font >
		ターゲットとは、一つの短いキーワード(ターゲット名)により、いくつかのホストの集合を示すためのものである.<br>
		一つのターゲットにはいくつかのホスト名を列挙して、そのターゲット名によりグループ分けする形になる.<br>
		以下の例を見てみよう.<br>
		<br>
		<b>【例】</b><br> 
		target.myf 内で以下のように2chとfutabaいうtarget名を定義し(このtarget名はユーザが自由に決めることができる)、<br>
		それぞれにホスト名を列挙しておく.<br>
		<br>
		<div class=MstyComment>
			@@L 2ch<br>
			*.2ch.net<br>
			*.bbspink.com<br>
			@@.<br>
			<br>
			@@L futaba<br>
			*.2chan.net<br>
			@@.<br>
		</div>
		<br>
		これにより、その他の箇所では単に "2ch" と "futaba" というキーワードで、上記のホストの集合を示すことができる.<br>
		ちなみにここでのパターンの記述においては一行につき一箇所のみにワイルドカードを使うこともできる.<br>
		例えば以下の記述はOKであり、アスタリスクの部分は任意の文字列と考えてよい.<br>
		may.2chan.net、jun.2chan.net などがこれにマッチする.<br>
		<br>
		<div class=MstyComment>
			*.2chan.net
		</div>
		<br>
		一方、例えば以下のように一行につきアスタリスクが２箇所以上ある記述は意図した通りのものとはならない.<br>
		<br>
		<div class=MstyComment>
			*.2chan.*
		</div>
		<br>
		この場合、一番目に現れたアスタリスクのみがワイルドカードとして扱われるが、<br>
		二番目に現れたアスタリスクは、文字通りアスタリスクそのものとして扱われる.<br>
		<br>
		myfというファイルはこのプロジェクト全般において設定ファイルなどを記述するのに用いる汎用のフォーマットである.<br>
		これの仕様について知りたい方は<a class=MstyElemLink href=https://github.com/mr-moai-2016/znk_project/blob/master/src/libZnk/myf_spec.md target=_blank>myf_spec</a>を参照していただきたい.<br>
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>


<a name=filter_recv></a>
<u><b>
受信フィルタについて
</b></u><br>
<br>
<div class=MstyIndent>
	Moaiでは、HTTPにおけるGETにて受信されるHTMLやJavascriptやCSSにおいて<br>
	その受信文字列を自由に置換(replace)したり、加工できるフィルター機能を備えている.  <br>
	これを指定しているのが、filters/<b>TARGET_NAME</b>_recv.myf になる.<br>
	<b>TARGET_NAME</b>の部分にはtarget.myfにおいて定義したターゲット名が入る.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=filter_recv_section1></a>
<u><b>
受信フィルタ : html_filter, js_filter, css_filter セクション
</b></u><br>
<br>
<div class=MstyIndent>
	<b>TARGET_NAME</b>_recv.myf ファイル内の html_filter、js_filter、css_filterという部分で<br>
	それぞれHTML、Javascript、CSSにおける文字列の置換を行うことができる.<br>
	この部分にはfiltersコマンドと呼ばれる命令列を記述する.<br>
	現在サポートされているコマンドはreplaceのみで、以下の形式で記述する.<br>
	<br>
	<div class=MstyComment>
	    replace ['置換前の文字列'] ['置換後の文字列']
	</div>
	<br>
	これは「前者を後者で置換(replace)せよ」という命令になる.<br>
	これをhtml_filter内で書いておけば、<b>TARGET_NAME</b>で指定されたホストにおいて<br>
	拡張子がHTMLのファイルのすべての行に対し、この文字列置換が行われる.<br>
	js_filter、css_filterについても同様である.<br>
	<br>
	置換前の文字列と置換後の文字列は必ず<b>['</b> と <b>']</b>　というクォーティング記号で囲う必要があることに注意すること.<br>
	大抵の用途では、このクォーティング記号で問題は起こらないと思われるが、<br>
	置換対象文字列内にこの記号が含まれるなどで、この記号だと都合が悪い場合は、<br>
	ファイルの最初の行にある @def_quote ディレクティブでこの記号を自由に変更することもできる.<br>
	例えば [' と '] の替わりに -[ と ]- を使いたいといった場合は、myfファイルの一番最初の行に<br>
	<br>
	<div class=MstyComment>
	    @def_quote -[ ]-
	</div>
	<br>
	と書いておく( -[ と ]- の間には必ずスペースを入れること ).<br>
	<br>
	<b>【例】</b><br>  
	<br>
	例えば掲示板「５ちゃんねる」を対象として、その受信HTMLとCSSを加工したいとしよう.<br>
	target.myf内で例えば5chという名前のtargetを定義し、filters/5ch_recv.myfというファイルを作成する.<br>
	このファイル内で以下のフィルタコマンドを指定する.<br>
	<br>
	<div class=MstyComment>
		@@L html_filter<br>
		replace ['デフォルトの名無しさん'] ['デフォルトのモアイさん']<br>
		@@.<br>
		<br>
		@@L css_filter<br>
		replace ['{background:rgb(239,239,239)}'] ['{background:rgb(240,224,214); color:rgb(127,0,0)}']<br>
		@@.<br>
	</div>
	<br>
	ファイルが作成できたら、Moaiを起動(再起動)し、この状態で普通に「５ちゃんねる」へとアクセスする.<br>
	<br>
	HTMLの内容が加工されて、名前欄の文字列が「デフォルトのモアイさん」へ変更されていることだろう.<br>
	またCSSの内容が加工されて、背景色と文字色も変更されているはずである. <br>
	もしも正しく設定したにもかかわらず表示が変わらないなら、ブラウザのキャッシュに古い情報が残っている可能性がある.<br>
	キャッシュをクリアしてからもう一度目的のサイトへアクセスしよう.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=filter_recv_section2></a>
<u><b>
受信フィルタ : css_additional セクション
</b></u><br>
<br>
<div class=MstyIndent>
	<b>TARGET_NAME</b>_recv.myf ファイル内の css_additional という部分で、<br>
	複数行に渡るユーザ独自のcssの記述を追加することができる.<br>
	CSSの知識がある方は、サイトによって指定しているスタイルをこの部分により上書きするなどすることで<br>
	独自のページデザインにカスタマイズするなどといったことが可能だ.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=filter_send></a>
<u><b>
送信フィルタについて
</b></u><br>
<br>
<div class=MstyIndent>
	Moaiでは、HTTPにおけるPOSTにて送信されるヘッダやPOST変数、クッキーの値において<br>
	その値の内容をある程度自由に置換(replace)できるフィルター機能を備えている.<br>
	これを指定しているのが、filters/<b>TARGET_NAME</b>_send.myf になる.<br>
	<b>TARGET_NAME</b>の部分にはtarget.myfにおいて定義したターゲット名が入る.<br>
	<br>
	このファイル内の header_vars、post_vars、cookie_vars、cookie_forceという部分で<br>
	それぞれHTTPヘッダ、POST変数、Cookieにおける値の置換を行うことができる.<br>
	これらには以下の変数代入形式を記述する.<br>
	<br>
	<div class=MstyComment>
		varname = ['置換後の値']<br>
	</div>
	<br>
	このようにMoaiでは、特にPOST変数のフィルタリングを比較的簡易に実現できる.<br>
	これに関しては同種のツールであるProxomitronなどに比べて有利な点の一つである.<br>
	<br>
	これらにおいて指定されていない変数に関しては何も加工修正はされず、<br>
	ブラウザにおいて設定された状態が単にそのまま送られる.<br>
	また右辺の置換後の値が空値のときは、文字通り空値へと置換される.<br>
	(ただしcookie_vars および cookie_force における変数が空値の場合は、<br>
	そのクッキー変数が存在しないことと等価である)<br>
	<br>
	また中間処理のため、実際に送信されるPOST変数に存在しない変数などを記述しておくこともできる.<br>
	この場合、フィルタ処理においてその変数は単に無視される.<br>
	<br>
	以下にそれぞれに関する詳細を述べる.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=filter_send_header_vars></a>
<u><b>
送信フィルタ : header_vars(HTTPヘッダの値の修正)
</b></u><br>
<br>
<div class=MstyIndent>
	一般にHTTPにおいてサイトへアクセスする場合、送信や受信されるデータ本体の直前に<br>
	HTTPヘッダと呼ばれるものが付加されて通信される.<br>
	例えば単純にブラウザから http://may.2chan.net/b/res/77777777.htm へURL指定したり、<br>
	そのページで「再読み込み」ボタンなどを押した場合は、概念的には以下のようなヘッダが送られる<br>
	（実際はもっと複雑であるかもしれない).<br>
	<br>
	<div class=MstyComment>
		GET /b/res/77777777.htm HTTP/1.1<br>
		Host: may.2chan.net<br>
		User-Agent: My Sexy Browser<br>
		Accept: */*<br>
		Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>
		Accept-Language: ja,en-US;q=0.7,en;q=0.3<br>
		Accept-Encoding: gzip, deflate<br>
		Referer: may.2chan.net/b/res/77777777.htm<br>
		Cookie: posttime=1464336000000; uuc=1<br>
		Connection: keep-alive<br>
	</div>
	<br>
	あるいは http://may.2chan.net/b/futaba.php?guid=on があて先となっているような掲示板へ<br>
	投稿しようとした場合、概念的には以下のようなヘッダが送られる<br>
	（実際はもっと複雑であるかもしれない).<br>
	<br>
	<div class=MstyComment>
		POST /b/futaba.php?guid=on HTTP/1.1<br>
		Host: may.2chan.net<br>
		User-Agent: Mozilla/5.0 Gecko/20041122 Firefox/1.0<br>
		Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>
		Accept-Language: ja,en-US;q=0.7,en;q=0.3<br>
		Accept-Encoding: gzip, deflate<br>
		Referer: http://may.2chan.net/b/res/77777777.htm<br>
		Cookie: posttime=1464336000000; uuc=1<br>
		Connection: keep-alive<br>
		Content-Type: multipart/form-data; boundary=---------------------------134281275020820<br>
		Content-Length: 2050<br>
		<br>
		(以下、Content-Lengthで指定されたバイト(ここでは2050バイト)の<br>
		POSTデータ本体(これをHTTPのBody部と呼ぶ)が続く)<br>
	</div>
	<br>
	Host や User-Agent といった <b>「:」 記号</b>の前にある部分がHTTPヘッダーの変数名となり、<br>
	それより後にある部分がその値を意味する.<br>
	上記よりお分かり戴けると思うが、いわゆるUser-Agentの値はHTTPヘッダーの変数の一種として格納される形になる.<br>
	従って、このヘッダー変数の値を修正することで、サイトに送られるUser-Agentを偽装することができる.<br>
	これを行うには、<b>TARGET_NAME</b>_send.myf ファイル内の<b>header_vars</b>において以下のように記述する.<br>
	<br>
	<div class=MstyComment>
		@@V header_vars<br>
		User-Agent = ['My Sexy Browser']<br>
		@@.<br>
	</div>
	<br>
	これによってUser-Agentの変数値が本来の値である Mozilla/5.0 Gecko/20041122 Firefox/1.0 から<br>
	My Sexy Browserという値に書き換えられた形でサイトへ送信される形となる.<br>
	以上がUser-Agent偽装の詳しいメカニズムとなる.<br>
	<br>
	まとめると、概念的にHTTPヘッダーの値は以下のような順番でフィルタリングされ、サイトへと流れていく.<br>
	<br>
	<span class=MstyComment>ブラウザにおける真のHTTPヘッダーの値</span> ⇒
	<span class=MstyComment>header_varsによる強制変更</span> ⇒
	<span class=MstyComment>目的のサイトへ送信</span>
	<br>
	<div class=MstyComment>
		<u><b>参考</b></u><br>  
		<br>
		header_vars 内のUser-Agent行を削除することによって、<br>
		<b>敢えてMoaiにおいてUser-Agent偽装を行わせない</b>ようにすることもできる.<br>
		例えば、ブラウザのUser-Agent偽装アドオンなどによって既にUser-Agentを任意の値に偽装している場合など<br>
		その偽装値をMoaiで再修正することなくそのまま送信して欲しいことがある.<br>
		<br>
		現状のMoaiはJavascriptにおけるnavigator.userAgentの値や<br>
		HTTPSによって暗号化されたHTTPヘッダにおけるUser-Agentまでは修正できないので、<br>
		場合によってはそのようなアドオンを使う方が偽装がより確実となることもあるかもしれない.<br>
		元通りMoaiによってUser-Agentを偽装させるようにするには、<br>
		User-Agent行を追加すればよい(このときの右辺値は適当なものでよい).<br>
	</div>
	<br>
	尚、User-Agent以外のその他のヘッダー変数の値も同様に変更することができるが<br>
	通常その必要はない上、不用意に変えると通信そのものが不可能になる恐れがあるので、<br>
	深い知識のある方以外はそれらを変更しない方がよい.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=filter_send_post_vars></a>
<u><b>
送信フィルタ : post_vars(POST変数の値の修正)
</b></u><br>
<br>
<div class=MstyIndent>
	投稿が可能な掲示板のHTMLのソースなどを開いてもらうと、<br>
	まず以下のように formタグで囲まれた領域がある.<br>
	<br>
	<div class=MstyComment>
		&lt;form action=... &gt;<br>
		...<br>
		&lt;/form&gt;<br>
	</div>
	<br>
	さらにその部分をよく観察すると以下のようなinputタグがいくつか書かれていることがわかる.<br>
	<br>
	<div class=MstyComment>
		&lt;input type=… name=... value=... &gt;<br>
		&lt;input type=… name=... value=... &gt;<br>
		...
	</div>
	<br>
	この<b>inputタグに書かれた内容</b>が最終的にはPOST変数となり、<br>
	POSTを行う場合(レス送信時など)に送信されるデータの本体に相当する.<br>
	実際のHTTP通信においてPOST変数はHTTP Body部のデータとしてHTTPヘッダーより後ろに配置される.<br>
	<br>
	POST変数がどういったものであるかは、これでお分かり頂けただろうか？<br>
	POST変数のさらなる具体例は以下の「トレーニング用例題」でも挙げて解説してあるので参照してほしい.<br>
	概念的にPOST変数の値は以下のような順番でフィルタリングされ、サイトへと流れていく.<br>
	<br>
	<span class=MstyComment>ブラウザにおける真のPOST変数値</span> ⇒
	<span class=MstyComment>post_varsによる強制変更</span> ⇒
	<span class=MstyComment>目的のサイトへ送信</span>
	<br>
	<b>【トレーニング用例題 Lv1】</b><br>
	<br>
	<div class=MstyIndent>
		例えば、ある架空の匿名掲示板のHTMLのソースに以下のような部分が含まれていたとしよう.<br>
		<br>
		<div class=MstyComment><br>
			&lt;form action="http://www.example.net/bbs.php" method="POST" enctype="multipart/form-data"&gt;<br>
			<br>
			&lt;input type=hidden name="himitu_no_data" value="12345678"&gt;<br>
			&lt;input type=hidden name="thread"         value="1000"&gt;<br>
			<br>
			&lt;b&gt;コメント&lt;/b&gt;&lt;textarea name="comment" cols="48" rows="4"&gt;&lt;/textarea&gt;&lt;br&gt;&lt;br&gt;<br>
			<br>
			&lt;b&gt;添付File&lt;/b&gt;&lt;input type=file name="upload_file" size="35"&gt;&lt;br&gt;&lt;br&gt;<br>
			<br>
			&lt;input type=checkbox name="text_only" value=on&gt;画像なし<br>
			<br>
			&lt;/form&gt;<br>
		</div>
		<br>
		これを実際にブラウザで開くと、以下のように表示されるはずである.<br>
		<br>
		<div class=MstyComment>
			<img src=/imgs/post_example_01.png width=100%>
		</div>
		<br>
		このHTMLの意味についてのヒントも列挙しておこう.<br>
		<ul>
			<li>レスの送信先はformのactionの値に記述されており、この例だと、http://www.example.net/bbs.php となる.</li>
			<br>
			<li>method、enctypeの部分はとりあえず気にしなくてよい(このあたりの指定はMoaiが適切に取り計らう).</li>
			<br>
			<li>inputタグ内のtype=hiddenという指定は、これが実際の画面には表示されない<b>隠されたPOST変数</b>であることを意味する.<br>
			この例では <b>himitu_no_data</b> と <b>thread</b> が該当する.</li>
			<br>
			<li>textareaタグ内の<b>comment</b>が文字列レスの内容となり、画面上ではテキスト入力フォームに相当する.<br>
			inputタグではないが、特例として<b>これもPOST変数</b>となる.</li>
			<br>
			<li>inputタグ内のtype=fileという指定は、画面上では添付ファイル用のダイアログを出すためのボタンに相当する.<br>
			この例では<b>upload_file</b>という名前の<b>POST変数</b>となり、<b>その値は添付ファイル</b>の全内容である.<br>
			(尚、この際に添付ファイルのファイル名も、そのフルパスが除去された形で付加される)</li>
			<br>
			<li>inputタグ内のtype=checkboxという指定は、画面上では文字通りチェックボックスに相当する.<br>
			この<b>チェックボックスにチェックを入れた場合のみPOST変数text_onlyが付加される</b>.<br>
			(チェックを入れてない場合はその変数は付加されない).<br>
		</ul>
		<br>
		まとめると、このフォームによって送られるすべてのPOST変数は以下となり、<br>
		これらが、http://www.example.net/bbs.php に送信される.<br>
		<br>
		<table>
			<tr class=MstyItemEvn><td>変数名        </td><td>値</td></tr>
			<tr class=MstyItemOdd><td>himitu_no_data</td><td>12345678</td></tr>
			<tr class=MstyItemOdd><td>thread        </td><td>1000</td></tr>
			<tr class=MstyItemOdd><td>comment       </td><td>ユーザがテキストフォームより入力したコメント文字列</td></tr>
			<tr class=MstyItemOdd><td>upload_file   </td><td>添付ファイルの全内容(ファイルを添付していない場合は空値となる)</td></tr>
			<tr class=MstyItemOdd><td>text_only     </td><td>on(ただしチェックを入れていない場合はこの変数そのものが存在しない)</td></tr>
		</table>
		<br>
		さて、前置きが長くなったが、この掲示板exampleではhimitu_no_dataというPOST変数により、<br>
		ユーザの識別を行っているものとしよう.<br>
		<b>Moaiによってこの値を適当な値に偽装せよ.</b><br>
		<br>
	</div>
	<br>
	<b>【トレーニング用例題 Lv1の解答】</b><br>
	<br>
	<div class=MstyIndent>
		まずtarget.myf内で例えばexampleという名前(この名前は自由に決めてよい)のtargetを定義する.<br>
		このファイルに以下のような指定を書き加えればよいだろう.<br>
		<br>
		<div class=MstyComment>
			@@L example<br>
			www.example.net<br>
			@@.<br>
		</div>
		<br>
		次に <b>TARGET_NAME</b>_send.myf に相当するものを作成する.<br>
		この例では、filters/example_send.myfというファイルを作成し、その内容を以下のようにする.<br>
		POST変数himitu_no_dataの真の値(12345678)を覆い隠して偽の値(87654321)で置換するため、<br>
		post_varsセクションにそれ用の行を設けた.<br>
		<br>
		<div class=MstyComment>
			@def_quote [' ']<br>
			<br>
			@@V header_vars<br>
			@@.<br>
			<br>
			@@V post_vars<br>
			himitu_no_data = ['87654321']<br>
			@@.<br>
			<br>
			@@V cookie_vars<br>
			@@.<br>
			<br>
			@@V cookie_force<br>
			@@.<br>
		</div>
		<br>
		最後に既にMoaiを起動している場合はtarget.myfとフィルタファイルfilters/example_send.myfをリロードしなければならない.<br>
		一度Moaiを終了してそれをもう一度起動するか、あるいはWeb Configuration画面で「Restart Moai」ボタンを押せばよい.<br>
		<br>
		以上である.<br>
		これで以降のMoaiを介した通信では、このターゲットのサイトのPOST変数himitu_no_dataに関しては、<br>
		常に上記の偽の値に置換される.<br>
	</div>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>
	

<a name=filter_send_cookie></a>
<u><b>
cookie_vars および cookie_force (Cookieの値の修正)  
</b></u><br>
<br>
<div class=MstyIndent>
	Cookieについては知っている方も多いであろう.<br>
	ブラウザの設定画面からも簡単に確認できるし、その内容を消去するのも同様に簡単である.<br>
	一般にこの値はサイト毎に別に記録される.<br>
	<br>
	例えば www.example.net と www.moai-chan.net という二つの異なるサイトがあったとすれば、<br>
	これらのCookieは別のカテゴリとして分離して記録される. <br>
	このとき、ある一つのカテゴリにあるサイトからは、それとは別のカテゴリにあるサイトのCookieの値を見ることはできない.<br>
	また同様に更新することもできない.<br>
	<br>
	また、大規模な匿名掲示板ではサーバが複数存在するようなサイトがある.<br>
	このような場合、サイト内のサーバ全体で共通して使われるCookie というものがある.<br>
	たとえばふたばちゃんねるでは、カテゴリ名が 2chan.net となっているCookieがあり、<br>
	このCookieはドメイン名が *.2chan.net となっているサーバからならばどのサーバからも参照可能である.<br>
	一方、カテゴリ名が may.2chan.net となっているCookieならば、ふたばちゃんねるのmayサーバだけから参照可能である.<br>
	このようにCookieはそのカテゴリー名にドメイン的な構造を持っており、<br>
	それによって参照可能な範囲が変わる場合がある.<br>
	<br>
	<div class=MstyComment>
		<u><b>Note.</b></u><br>
		<br>
		ところで気づかれたかもしれないが、上記HTTPヘッダー変数の解説においても<br>
		<b>Cookieという名前の変数</b>が現れている.<br>
		実は Cookieデータというものは最終的には<b>HTTPヘッダ内のCookie変数</b>にパックされて送信が行われており、<br>
		つまり上記で説明したheader_varsによってCookie変数を修正することも面倒だが不可能ではない.<br>
		また一方、HTTPヘッダ変数Set-Cookieによって、Cookieデータの新規作成や更新などが行われ、<br>
		これも同様の考え方で修正することもできる.<br>
		<br>
		しかし、ヘッダ変数CookieまたはSet-Cookieの値は複雑なフォーマットを持っており、<br>
		仮にheader_varsによってこの値を修正するとなれば、このフォーマットを自力で解釈するプログラムが別途必要となる.<br>
		cookie_vars および cookie_force を用いればその作業は不要となり、簡易にCookie値の加工が可能となる.<br>
	</div>
	<br>
	cookie_vars において指定された変数は、ブラウザにおける真の値を上書きする.<br>
	ただしtargetとなるサイトがSet-Cookieによって新たなCookie値を設定して来た場合、<br>
	cookie_varsの変数値はその値で自動的に書き換えられる. <br>
	あるいはcookie_varsにまだその変数が存在しない場合は自動的に新規追加される.<br>
	<br>
	この辺りはheader_varsやpost_varsに比べ、やや複雑な仕様である.<br>
	しかし、<b>サイトがSet-Cookieを発行するまでの間、<br>
	ある種のCookie変数の値を一時的に空にしておきたいケース</b>は割とあり、<br>
	この仕様ならそれが自然に実現できるのである.<br>
	<br>
	一方、cookie_force において指定された変数は、ブラウザにおける真の値を上書きし、<br>
	さらにcookie_varsにおける指定さえも強制的に上書きする.<br>
	また、cookie_forceにおける指定はcookie_varsと異なり、基本的に書き換えられることはない.<br>
	例えばあるCookie変数を問答無用で常に削除しておきたい場合は、<br>
	cookie_forceにおいてその変数を空値に指定しておけばよい.<br>
	<br>
	まとめると、概念的にCookieの値は以下のような順番でフィルタリングされ、サイトへと流れていく.<br>
	<br>
	<span class=MstyComment>ブラウザにおける真のCookie値</span> ⇒
	<span class=MstyComment>cookie_varsによる変更</span> ⇒
	<span class=MstyComment>cookie_forceによる強制変更</span> ⇒
	<span class=MstyComment>目的のサイトへ送信</span>
	<br>
	
	<b>【トレーニング用例題 Lv2】</b><br>  
	<br>
	<div class=MstyIndent>
		例えば、掲示板moai-chanという架空の掲示板を考えよう.<br>
		この掲示板には mei.moai-chan.net と imoge.moai-chan.netという二つのサーバが存在し、<br>
		これらのHTMLのソースはいずれも以下のような部分が含まれているものとする.<br>
		<br>
		<div class=MstyComment>
			&lt;head&gt;<br>
			&lt;base href="http://mei.moai-chan.net/"&gt;<br>
			&lt;/head&gt;<br>
			<br>
			&lt;form action="moai.php" method="POST"&gt;<br>
			<br>
			&lt;input type=hidden name="entry_time"     value="2016/06/01/12:05:25"&gt;<br>
			&lt;input type=hidden name="secret_of_fing" value="192837465"&gt;<br>
			<br>
			&lt;b&gt;おなまえ&lt;/b&gt;&lt;input type=text name="your_name" size="28"&gt;&lt;br&gt;&lt;br&gt;<br>
			&lt;b&gt;メール欄&lt;/b&gt;&lt;input type=text name="your_mail" size="28"&gt;&lt;br&gt;&lt;br&gt;<br>
			&lt;b&gt;コメント&lt;/b&gt;&lt;textarea name="comment" cols="48" rows="4"&gt;&lt;/textarea&gt;&lt;br&gt;&lt;br&gt;<br>
			<br>
			&lt;b&gt;添付File&lt;/b&gt;&lt;input type=file name="upload_file" size="35"&gt;&lt;br&gt;&lt;br&gt;<br>
			<br>
			&lt;input type=checkbox name="text_only" value=on&gt;画像なし<br>
			<br>
			&lt;/form&gt;<br>
		</div>
		<br>
		２つ目の例題なので、解説はある程度省略しよう.<br>
		ちなみに、この例は我々Moai開発チームの１人である高速ヤキソバ変換氏が作成したものだ.<br>
		氏によれば、この例は大分ふたばちゃんねるの状況に近いとのことである.<br>
		<br>
		以下に簡単にこのHTMLに関するヒントを列挙しておく.<br>
		<ul>
			<li>この例のformタグ内のactionでは、URLがフルパスで記述されていないが、<br>
			これはすぐ上のbaseタグによってこの指定より上に来るべきパスを指定しているためである.<br>
			尚、ここでのbaseタグの値は、mei.moai-chan.net 向けのものとなっているが、<br>
			もう一つのサーバimoge.moai-chan.netの場合は同様にここがそれ向けの値になっていると考えればよい.</li>
			<br>
			<li>この例ではformタグ内にenctypeが指定されていないが、<br>
			この場合application/x-www-form-urlencodedが指定されたのと同じになる.<br>
			いずれにせよこれに関して気にする必要はない.</li>
			<br>
			<li>inputタグ内のtype=textは、画面上では「おなまえ」や「メール欄」などの一行文字列入力フォームに相当する.<br>
			勿論これもPOST変数となる.</li>
		</ul>
		<br>
		さて、この架空の掲示板moai-chanでは<b>secret_of_fing</b>において、<br>
		あなたのマシン環境のFingerprint値を設定しているものとしよう.<br>
		Fingerprintとはマシン固有の色々な情報をかき集めて足し合わせ、それをハッシュ値としたものである.<br>
		<br>
		また、あなたが初めてこの掲示板に入場した場合、moai-chanは <b>cok_entry_time</b> というCookie変数を作って<br>
		その初入場の時刻の情報をあなたのブラウザのCookieに保存しているものとする.<br>
		逆に言えば、もしcok_entry_timeがあなたのブラウザのCookieに既に存在するなら、<br>
		あなたのブラウザは以前にもその掲示板に入場したことがあると判断されるのである.<br>
		<br>
		そして、この掲示板では入場後のレス投稿の際Javascriptが実行されて<br>
		あなたのブラウザのCookie内のcok_entry_timeの値を参照し、<br>
		<b>POST変数entry_time</b>にその値を設定した上で、それをレス内容とともに送信する仕組みになっているものとしよう.<br>
		つまりあなたの初入場の時刻が一種のユーザ識別IDとなって随時送信される仕組みとなっている.<br>
		moai-chanでは、secret_of_fing と entry_time の二つをもってユーザの識別を行っているものとする.<br>
		<br>
		まず<b>cok_entry_timeを空値で覆い隠し、あたかも初めてこの掲示板に入場したかのような状況</b>をシミュレートせよ.<br>
		次に<b>入場後のレス投稿の際、Cookie値とPOST変数値をどのように偽装しておくべきか</b>を考えよ.</b><br>
		<br>
	</div>
	<br>
	<b>【トレーニング用例題 Lv2の解答】</b><br>
	<br>
	<div class=MstyIndent>
		<br>
		まず、moai-chanという名前(この名前は自由に決めてよい)のtargetを定義する.<br>
		target.myfファイルに以下のような指定を書き加えればよいだろう.<br>
		<br>
		<div class=MstyComment>
			@@L moai-chan<br>
			*.moai-chan.net<br>
			@@.<br>
		</div>
		<br>
		次に <b>TARGET_NAME</b>_send.myf に相当するものを作成する.<br>
		この例では、filters/moai-chan_send.myfというファイルを作成し、その内容を以下のようにする.<br>
		<br>
		<div class=MstyComment>
			@def_quote [' ']<br>
			<br>
			@@V header_vars<br>
			@@.<br>
			<br>
			@@V post_vars<br>
			entry_time = ['']<br>
			secret_of_fing = ['07210721']<br>
			@@.<br>
			<br>
			# Cookie値のフィルタリング<br>
			# ここでの指定はサイトがSet-Cookieを発行した時点で自動的に書き変えられることがある.<br>
			@@V cookie_vars<br>
			cok_entry_time = ['']<br>
			@@.<br>
			<br>
			# Cookie値の強制変更<br>
			# ここでの指定はサイトがSet-Cookieを発行しても書き変えられることはない.<br>
			@@V cookie_force<br>
			@@.<br>
		</div>
		<br>
		変数cok_entry_timeを空値に設定することにより、moai-chan.netがこれに新たな値を明示的に設定するまで<br>
		このCookieの値は存在していないのと同じになる.<br>
		(この変数に関して、ブラウザに実際に設定されている真の値を覆い隠す.)<br>
		また、moai-chan.netがこれに新たな値を明示的に設定した瞬間、Moaiは filters/moai-chan_send.myfを更新し、<br>
		上記cookie_vars内のcok_entry_timeの値は、自動的にその新しい値に更新される.<br>
		<br>
		少し難しいだろうか？<br>
		この辺りの処理はMoaiがすべてうまく取り計らってくれる.<br>
		まあこの場合、素直に実際のブラウザのCookieを削除した方が早いだろうが、<br>
		ここではcookie_varsフィルタの練習例として、このような方法を紹介している.<br>
		<br>
		この状態でmoai-chan.netにアクセスすると、moai-chan.net から見ればあたかも<br>
		cok_entry_time の値が空であるかのように見えるのである.<br>
		つまり、あたかも初入場であるかのごとき状況をシミュレートできるだろう.<br>
		そして初入場とみなされたのであるから、cok_entry_timeにはあなたの入場時刻がセットされることだろう.<br>
		Moaiはそれを見逃さずキャッチし、filters/moai-chan_send.myfにその値を記録する.<br>
		<br>
		では次に、レス投稿する際のCookieとPOST変数の偽装すべき値について考える.<br>
		POST変数secret_of_fingの値はあらかじめ適当な値にでっちあげておけばよい.<br>
		一方、cok_entry_time については、moai-chan.netのJavascriptがあなたのブラウザのCookieへと直接参照しにいく.<br>
		filters/moai-chan_send.myf内のcok_entry_timeには、上記の手法でうまく偽装が完了した入場時刻がセットされてはいるのだが、<br>
		残念ながらJavascriptはこれを参照しない.<br>
		cookie_varsフィルターで偽装できるのはHTTPヘッダへCookie値を乗せて送る場合に限られるのである.<br>
		このままではブラウザにある真のcok_entry_timeの値がPOST変数entry_timeに乗せて送られてしまう.<br>
		どうすればよいだろうか？<br>
		<br>
		視点を変えよう.<br>
		最終的にはPOST変数entry_timeに乗せて送られるのであるから、Cookieそのものではなく、<br>
		POST変数の方をフィルターすればよいのである.<br>
		つまりpost_vars内のentry_timeの値を書き換える.<br>
		具体的にはcookie_vars内のcok_entry_timeに記録されている値で書き換えればいいだろう.<br>
		<br>
		問題はどうやって書き換えるかだが、手動でやるならfilters/moai-chan_send.myfをテキストエディターで開き、<br>
		cok_entry_timeに今どのような値が設定されたかを見て、その値をPOST変数entry_timeの値として書き換えることになる.<br>
		(この辺りはplugin等のツールを用いれば自動化できるが、ここではそこまでは踏み込まない.)<br>
		<br>
		最後に既にMoaiを起動している場合はtarget.myfとフィルタファイルfilters/moai-chan_send.myfをリロードしなければならない.<br>
		一度Moaiを終了してそれをもう一度起動するか、あるいはWeb Configuration画面で「Restart Moai」ボタンを押せばよい.<br>
		<br>
		以上である.<br>
		これで以降のMoaiを介した通信では、このターゲットのサイトのPOST変数secret_of_fingとentry_timeに関しては、<br>
		常に上記の偽の値に置換される.<br>
		<br>
	</div>
	<br>
	<b>【実践例題】</b><br>
	<br>
	<div class=MstyIndent>
		最後に実際の適用例も出しておこう.<br>
		ちなみに、この例も我々Moai開発チームの１人である高速ヤキソバ変換氏が作成したものだ.<br>
		(pluginは用いない方法なので一部面倒だが)<br>
		<br>
		例えば掲示板「ふたばちゃんねる」を対象として、その送信ヘッダとPOST変数とCookieの値を加工したいとしよう.<br>
		target.myf内で例えばfutabaという名前のtargetを定義し、filters/futaba_send.myfというファイルを作成する.<br>
		このファイル内で以下の指定を行う.<br>
		<br>
		<div class=MstyComment>
			@@V header_vars<br>
			User-Agent = ['Mozilla/5.0 MyBrowser_MoreMoreFireSexy']<br>
			@@.<br>
			<br>
			@@V post_vars<br>
			pthb = ['']<br>
			pthc = ['']<br>
			pthd = ['']<br>
			flrv = ['2739407074']<br>
			flvv = ['3792482965']<br>
			scsz = ['800x600x32']<br>
			pwd = ['']<br>
			js = ['on']<br>
			@@.<br>
			<br>
			# Cookie値のフィルタリング<br>
			# ここでの指定はサイトがSet-Cookieを発行した時点で自動的に書き変えられることがある.<br>
			@@V cookie_vars<br>
			posttime = ['']<br>
			pwdc = ['']<br>
			cxyl = ['5x3x2x0x2']<br>
			@@.<br>
			<br>
			# Cookie値の強制変更<br>
			# ここでの指定はサイトがSet-Cookieを発行しても書き変えられることはない.<br>
			@@V cookie_force<br>
			namec = ['']<br>
			@@.<br>
		</div>
		<br>
		この例では、HTTPヘッダ変数のうち、User-Agent の値を「Mozilla/5.0 MyBrowser_MoreMoreFireSexy」へと変更している.<br>
		また、flrv, flvv, scszの値も適当な値にでっちあげておく.<br>
		ファイルが作成できたら、Moaiを起動(再起動)し、この状態で普通に「ふたばちゃんねる」のカタログ(要はfutaba.php)を開く.<br>
		<br>
		初回のカタログアクセスにおいて、上記のうちcookie_vars内のposttimeの値が、<br>
		ふたばによって発行された値に書き換わるはずである.<br>
		この後もう一度 filters/futaba_send.myf を開き、pthbとpthcの値を新しいposttimeの値に書き直しておく.<br>
		(pthbとpthcを空のままにしておいてもいけるケースもあるかもしれない.<br>
		また厳密に言えばpthcに設定すべき値は/bin/cachemt7.phpによって発行される最新の値である必要があるが、<br>
		この練習用例題ではとりあえずそこは妥協する)<br>
		<br>
		以上でフィルタの初期化が完了である.<br>
		これに加えIPも変更しておけば、以降はMoai起動中は特に何もせずとも普通にレスやスレ立てが出来るようになっているハズだ.<br>
		<br>
		尚、ここでは練習用例題としてこのような方法を紹介したが、普通はこんなことをしなくても「Virtual USERS Initiation」<br>
		ボタンを押せば一発で初期化完了である.<br>
		このボタンによりMoaiに付属しているfutabaプラグインが呼び出され、まさに上記の処理を内部で瞬時に行ってくれる.<br>
		<br>
		<div class=MstyComment>
			<u><b>おまけ</b></u><br>
			<br>
			上記でcxylというのは、<br>
			<br>
			<div class=MstyComment>
				横のスレ個数 x 縦のスレ個数 x 各スレでの文字数 x 文字位置(0:下,1:右) x 画像サイズ(0から6までで0が最小で旧来の表示)
			</div>
			<br>
			というフォーマットを持つ記述子であり、これを指定しない場合、<br>
			futaba.phpはデフォルトとして ['14x6x4x0x0'] を指定したものとみなすようである.<br>
			<br>
			またnamecというのは、最後のレスにおいて使用したお名前欄の内容であり、<br>
			ここではこれを強制的に空値へとリセット(Cookie変数を削除)している.<br>
		</div>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=ignore_hosts></a>
<u><b>
無用なホストへの接続をブロックする(ignore_hosts機能)
</b></u><br>
<br>
<div class=MstyIndent>
	config.myf 内の ignore_hosts に記載されているホストへブラウザが接続しようとした場合<br>
	Moaiはその通信そのものをブロックする.<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0ではこの指定はconfig.myfではなく、hosts.myfで行うように仕様が変更になりました.
	</div><br>
	例えばあなたがいつも見ているサイト内に大量の広告があり、それらのバナーなどが外部サイトにある場合<br>
	このままではそれらの外部サイトすべてに対して「TCPコネクションの確立」を行わなければならない.<br>
	「TCPコネクションの確立」という処理は非常に重い(時間がかかる)ので、本当に表示の高速化を図りたいなら<br>
	無駄な接続を未然に防ぐのが一番効果的なのである.<br>
	<br>
	以下に例を示す.<br>
	ちなみにここでのパターンの記述においてはtargetでの指定と同様の形でワイルドカードを使うこともできる.<br>
	<br>
	<div class=MstyComment>
		@@L ignore_hosts<br>
		free2.jp<br>
		api.digiket.com<br>
		js.ad-stir.com<br>
		aladdin.genieesspv.jp<br>
		*.socdm.com<br>
		j.microad.net<br>
		www.assoc-amazon.jp<br>
		@@.
	</div><br>
	configファイル中に例えばこのように記述しておくと、あなたがいつも見ているサイトのページ中に<br>
	上記の外部サイトへアクセスしようとする部分がある場合、それらの外部サイトへの接続を未然に防止する.<br>
	そして替わりにその部分には以下のようなメッセージが表示される.<br>
	<br>
	<div class=MstyComment>
		Moai : Ignored Host Blocking[<b>blocked_hostname</b>] sock=[1234].<br>
	</div>
	<br>
	<b>blocked_hostname</b>の部分には、どのホストへのアクセスをブロックしたかが表示される.<br>
	つまり上記で指定したホストのいずれかが表示されるはずである.<br>
	sockの部分は気にする必要はないが、接続の際に使ったソケットの番号を示している.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=post_confirm></a>
<u><b>
POST時の確認メッセージ表示(post_confirm機能) 
</b></u><br>
<br>
<div class=MstyIndent>
	ここで簡単におさらいしよう.<br>
	POSTとは掲示板などへスレ立てやレス投稿をする際に行われるHTTPリクエストのことである.<br>
	そしてこのときHTTPヘッダやサーバが定義した変数(POST変数と呼ぶ)、クッキーの値などが送信される.<br>
	<br>
	config.myf内のpost_confirmの値が on のとき、これらの値をすべて確認表示する画面を出すことができる.<br>
	(テキストだけの非常に地味な画面ではあるが、これからそのサイトに何が送られるかが余すことなく表示され、<br>
	 状況を把握や分析をするには十分役に立つだろう).<br>
	この画面が出ている段階では、まだ投稿は行われていない.<br>
	一番下にある「Send」ボタンを押すことで、この内容で<b>実際に</b>投稿される.<br>
	<br>
	ただし、この画面が表示されるのはconfig.myf内にあるpost_confirm_hostsに記載されたホストに対してPOSTする場合のみである.<br>
	(そこに記載されていないホストに対してはpost_confirmがonであってもこの画面は表示されない).<br>
	ちなみにここでのパターンの記述においてはtargetでの指定と同様の形でワイルドカードを使うこともできる.<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0ではこの指定はconfig.myfではなく、hosts.myfで行うように仕様が変更になりました.
	</div><br>
	post_confirm_hostsなどでわざわざ範囲を絞らずにすべてのサイトを対象にすればよいのではないかと思われる方もいるだろうが<br>
	Nico動画など一部のサイトでは、スクリプトなどで自動的なPOSTが内部で行われている場合があり、<br>
	そのような場合これを有効にしておくと問題が発生するため、この画面が発動するホストを選択指定できるようにしてある.<br>
	<br>
	一方、post_confirm の値が off のとき、すべてのサイトに対してこの確認画面は表示は無効となる.<br>
	<br>
	<div class=MstyComment>
		<b><u>【注意】</u></b><br>  
		<br>
		例えばふたば用のアドオン赤福などを使用している場合、このモードがonの場合に内部処理が競合し、<br>
		レス送信などがうまく行えないようである.<br>
		赤福が有効な状態で、この問題をうまく回避する方法は今のところみつかっていない.<br>
		この場合もやはりpost_confirmそのものを無効にしておく必要がある.<br>
		もっともこの確認画面表示は今となっては解析用に使用するくらいであり、普通は必要ないものであるため、<br>
		バージョン1.0より、この指定はデフォルトではoffとしてある.<br>
		どうしても確認画面を出したい場合は赤福を一時的に無効にしてレス投稿しよう.<br>
	</div>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=acceptable_host></a>
<u><b>
他のマシンからの接続を許可/制限する
</b></u><br>
<br>
<div class=MstyIndent>
	Moaiは他のマシンからの接続の受付もサポートする.<br>
	<br>
	これはご家庭にある２台目３代目のマシン等から、Moaiの起動している１台目のマシンへ接続して<br>
	Moaiの提供する機能を利用するといったような用途を想定している.<br>
	概念的には以下のような接続になる.<br>
	<br>
	<span class=MstyComment>他のマシン上にあるブラウザ</span> ⇒
	<span class=MstyComment>Moaiの起動しているマシン上にあるMoai</span> ⇒
	<span class=MstyComment>送信先のサイト</span><br>
	<br>
	この接続の許可/不許の防衛機構としてMoaiは２段階設けてあり、あるIPからの接続を通過させるには、<br>
	この双方を許可する必要がある.<br>
	<br>
	<b>第１の段階 : config.myf内のacceptable_hostにおける指定</b><br>
	この値でANYを指定することにより他のマシンからの接続が可能となり、LOOPBACKを指定することにより、<br>
	自マシン以外は問答無用で遮断するようになる.<br>
	デフォルトでは安全のため、一応LOOPBACKとしてある.<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0ではこの指定はconfig.myfではなく、hosts.myfで行うように仕様が変更になりました.
	</div><br>
	<b>第２の段階 : config.myf内のaccess_allow_ips と access_deny_ips の指定</b><br>
	access_allow_ips において接続を許可するIP群を指定する(ホスト名ではなく必ずIPでなければならない).<br>
	access_allow_ipsに何も記述しない場合は、localhostを除くすべてのマシンからの接続は不許となる<br>
	(この場合、接続元にはForbiddenメッセージを返す形になる).<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0ではこの指定はconfig.myfではなく、hosts.myfで行うように仕様が変更になりました.
	</div><br>
	このaccess_allow_ipsの指定だけでも通常十分であるが、ここからさらに例外的に接続を不可とする<br>
	IP群をaccess_deny_ipsにおいて指定することができる.<br>
	<br>
	例えばLAN内からのみの接続を許可するには、典型的には以下の記述でよいだろう.<br>
	ちなみにパターンの記述においては一行につき一箇所のみにワイルドカードを使うことができる.<br>
	<br>
	<div class=MstyComment>
		@@L access_allow_ips<br>
		192.168.*<br>
		@@.<br>
	</div>
	<br>
	さらに例えばLAN内の192.168.1.66のマシンのみ、理由あって接続を不許としたい場合は、<br>
	access_allow_ipsに以下を記述しておくとよい.<br>
	<br>
	<div class=MstyComment>
		@@L access_deny_ips<br>
		192.168.1.66<br>
		@@.<br>
	</div>
	<br>
	勿論、ルータやOSなどにあるファイアウォール機能でWAN(外部インターネット)からのポート8124への<br>
	不要な接続を防止するのもセキュリティ上基本的な対策だ.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=proxy1></a>
<u><b>
外部プロキシを使いたい場合どうするのか？
</b></u><br>
<br>
<div class=MstyIndent>
	ブラウザのプロキシ設定ダイアログには既にlocalhost(127.0.0.1)を指定してしまっている.<br>
	これでは外部プロキシを利用できなくなるので困るという方もおられよう.<br>
	<br>
	Moaiでは次の接続仲介先として外部プロキシ(parent proxy, 親プロキシなどとも呼ばれる)を設定することができる.<br>
	このときは、概念的に次のような接続になる.<br>
	<br>
	<span class=MstyComment>あなたのブラウザ環境</span> ⇒
	<span class=MstyComment>ローカルプロキシMoai</span> ⇒
	<span class=MstyComment>外部プロキシ        </span> ⇒
	<span class=MstyComment>送信先のサイト</span><br>
	<br>
	これを実現するためには config.myf の parent_proxy の値を以下の形式で与える.<br>
	<br>
	<div class=MstyComment>
		 外部プロキシのホスト名またはIP:外部プロキシのポート<br>
	</div>
	<br>
	例えば以下のように記述することで外部プロキシproxy.example.net:3128を経由して目的のサイトへ<br>
	アクセスすることができる(proxy.example.net:3128が有効であればの話だが).<br>
	<br>
	<div class=MstyComment>
		 parent_proxy = ['proxy.example.net:3128']<br>
	</div>
	<br>
	外部プロキシを使わない場合(目的のサイトへ直接アクセスする場合)は値として以下のようにNONEを指定する.<br>
	(あるいは空値または :0 でもよい)<br>
	<br>
	<div class=MstyComment>
		 parent_proxy = ['NONE']<br>
	</div>
	<br>
	尚、moaiと同フォルダ内にparent_proxy.txtというファイルを作り、そこに使用したいプロキシの候補を<br>
	複数列挙しておくことで、Moai Web Configuration上でこれらのプロキシがメニュー表示されるようになる.<br>
	このメニューより、現在使用するプロキシを簡単かつ瞬時に切り替えすることも可能だ.<br>
	<br>
	ところでIPアドレスを変えるだけなら通常はルーカチで十分であるし、有効な外部プロキシを見つけるのもそう簡単ではない.<br>
	というわけでルーカチが使える状況ならばそちらの使用をお勧めする.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=proxy2></a>
<u><b>
外部プロキシの適用を一部のサイトのみに限定する
</b></u><br>
<br>
<div class=MstyIndent>
	例えば、あるサイトdanger.netを見る場合のみ理由あって外部プロキシを使用したいとする.<br>
	(その他すべてのサイトでは外部プロキシを使用したくないとする).<br>
	外部プロキシを介すると表示が遅くなったりするので、使う必要がないサイトならば使わない方が快適だ.<br>
	<br>
	その場合、config.myf内のproxy_applyに外部プロキシを使用したいサイトを記述しておく.<br>
	また、同じくconfig.myf内のproxy_exceptに例外的に外部proxyを使わないサイトを記述しておく.<br>
	尚、proxy_applyと被るものについてはproxy_exceptの指定が優先される.<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0ではこの指定はconfig.myfではなく、hosts.myfで行うように仕様が変更になりました.
	</div><br>
	以下に例を示す.<br>
	<br>
	<div class=MstyComment>
		@@L proxy_apply<br>
		*.2chan.net<br>
		taruo.net<br>
		@@.<br>
		<br>
		@@L proxy_except<br>
		jun.2chan.net<br>
		@@.<br>
	</div>
	<br>
	上記のように記述した場合、最終的にアクセスする目的のサイトが例えば may.2chan.net や img.2chan.net の場合は、<br>
	proxy_applyに一致するパターンが存在するので、現在の外部プロキシを中継して接続が行われる.<br>
	しかし jun.2chan.netだけは proxy_exceptで指定されているので例外的に外部プロキシを使わない形になる.<br>
	(たとえばお宝画像を手っ取り早く収集したいだけなのに間に処理が遅くなるproxyを挟むのは無駄であろう)<br>
	上記の記述に存在しないその他の一般サイトにアクセスする場合は外部プロキシは使われない.<br>
	<br>
	また、この考え方を逆にした指定もできる.<br>
	<br>
	例えば、あるサイトを見る場合のみ外部プロキシを使用しないとする.<br>
	(その他すべてのサイトでは外部プロキシを使用したいとする).<br>
	その場合は以下のようにすればよい.<br>
	<br>
	<div class=MstyComment>
		@@L proxy_apply<br>
		*<br>
		@@.<br>
		<br>
		@@L proxy_except<br>
		safe.net<br>
		127.0.0.1<br>
		localhost<br>
		192.168.*<br>
		@@.<br>
	</div>
	<br>
	上記のように記述した場合、まずproxy_applyにおいて全てのサイトが外部プロキシの適用対象となる.<br>
	次にproxy_exceptにより、そこから例外的に使用が除外されるサイトが指定される形となる.<br>
	この例では、最終的にアクセスする目的のサイトがsafe.netまたはlocalhostや127.0.0.1、<br>
	あるいはIPが 192.168.* のLAN上のマシンの場合、外部プロキシは使われない.<br>
	その他の一般サイトにアクセスする場合は現在の外部プロキシが使われる.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=proxy3></a>
<u><b>
その他のローカルプロキシにチェーンする場合
</b></u><br>
<br>
<div class=MstyIndent>
	Moaiはその他のローカルプロキシと直列に繋げることもできる.<br>
	例えばPolipoとのコラボも可能であることを確認している.<br>
	これによってPolipoとMoaiの恩恵を同時に享受できる.<br>
	概念的に次のような接続になる.<br>
	<br>
	<span class=MstyComment>あなたのブラウザ環境</span> ⇒
	<span class=MstyComment>ローカルプロキシMoai</span> ⇒
	<span class=MstyComment>ローカルプロキシPolipo</span> ⇒
	<span class=MstyComment>送信先のサイト</span><br>
	<br>
	設定手順は外部プロキシを指定する場合と全く同様に行える.<br>
	おそらくデフォルトではPolipoは8123ポートを使っているので、parent_proxyに直接localhost:8123を指定するか<br>
	あるいは parent_proxy.txt に localhost:8123 を追加しておき、必要になったら Moai Web configrationにおいて<br>
	parent_proxyからそれを選べばよい.<br>
	<br>
	あるいは以下のように順番が逆でも可能である.<br>
	<br>
	<span class=MstyComment>あなたのブラウザ環境</span> ⇒
	<span class=MstyComment>ローカルプロキシPolipo</span> ⇒
	<span class=MstyComment>ローカルプロキシMoai</span> ⇒
	<span class=MstyComment>送信先のサイト</span><br>
	<br>
	この場合はPolipo側の設定ファイルを変更し、Moai(ポート8124)へ接続するようにしなければならない.<br>
	すなわちPolipoのconfig.cfgにおいて parentProxyをlocalhost:8124とする形になるだろう.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=web_config></a>
<u><b>
Moai Web Configuration
</b></u><br>
<br>
<div class=MstyIndent>
	ブラウザのURL指定欄に http://127.0.0.1:8124/config と指定することで表示させることができる.<br>
	これまでに述べたconfig.myf内の変数をWeb上から確認および設定できるというものである.<br>
	<br>
	<div class=MstyComment>
		Moai Ver2.0では、これは「Moaiエンジン設定」という画面に刷新されており、<br>
		扱える項目も若干異なります.<br>
		特に「Virtual USERS Initiation」ボタンが廃止されていることに注意してください.<br>
	</div><br>
	<div class=MstyComment>
	<img src=/imgs/screenshot_config.png width=100%>
	</div><br>
	<br>
	<b>Filters and Plugins</b><br> 
	<br>
	<div class=MstyIndent>
		ここではプラグインとして登録されているターゲットの<b>Virtual USERS Initiation</b>機能を呼び出す.<br>
		これにより、具体的に何が実行されるかはプラグインによるが、その実行結果がすぐ下に表示される.<br>
		例えば、掲示板の投稿用sendフィルタの変数値をランダマイズ化したり仮想化したりなどが<br>
		「Virtual USERS Initiation」ボタンにより行える.<br>
	</div><br>
	<b>Functional Configuration</b><br>
	<br>
	<div class=MstyIndent>
		ここではMoaiの機能に関する設定を行う.
		<br>
		<ul>
			<li><b>parent_proxy:</b><br>
			このメニューでは parent_proxy.txt の内容が表示される.<br>
			ここから現在使用するプロキシを選んで「Update」を押せば使用する外部プロキシの瞬時切り替えができる.<br>
			</li>
			<br>
			<li><b>post_confirm:</b><br>
			POST時の確認画面表示モードのon/offを切り替える.<br>
			チェックボックスをクリックして値を切り替えた上で「Update」を押せば設定が反映される.<br>
			</li>
			<br>
			<li><b>enable_log_file:</b><br>
			moai_log.logへ全Log情報を書き出すか否かを切り替える.<br>
			チェックボックスをクリックして値を切り替えた上で「Update」を押せば設定が反映される.<br>
			</li>
			<br>
			<li><b>enable_log_verbose:</b><br>
			Log情報をさらに詳細に書き出すか否かを切り替える.<br>
			チェックボックスをクリックして値を切り替えた上で「Update」を押せば設定が反映される.<br>
			</li>
			<br>
			<li><b>blocking_mode:</b><br>
			ソケット通信におけるブロッキング接続モードのon/offを切り替える.<br>
			onのときブロッキング接続、offのとき非ブロッキング接続となるが、<br>
			通常後者の方が快適に閲覧が可能であり、特に問題ない限りはoffでよい.<br>
			チェックボックスをクリックして値を切り替えた上で「Update」を押せば設定が反映される.<br>
			</li>
		</ul>
	</div><br>

	<b>System Configuration</b><br>  
	<br>
	<div class=MstyIndent>
		ここではMoaiの通信システムの根本に関わる設定を行えるが、設定を変更される場合は細心の注意が必要である. <br>
		またこの設定変更はMoaiが起動しているマシン上からしか行えないようになっている.<br>
		(外部マシンからリモートでは行えないということ).<br>
		「Update System」ボタンを押すことでMoaiを再起動するよう促すメッセージが表示される.<br>
		そこからさらに「Restart Moai」ボタンを押すことでMoaiサーバが再起動され設定が反映される形となる.<br>
		<br>
		<ul>
			<li><b>acceptable_host:</b><br>
			この値がLOOPBACKである場合は問答無用で他マシンからの接続を排除する.<br>
			このときacceptそのものが行われないため、DOS攻撃に対する防御力は増す.<br>
			一方、この値がANYである場合はすべてのマシンからの接続を認める.<br>
			しかし、このままだと極端な話、ルータなどのファイアウォール機構がない環境ではWANからの接続も認めてしまうことになる.<br>
			「LAN からの接続のみ許可」といった意味を持つ特別な設定値を提供したいところではあるが、<br>
			残念ながら、OSのネットワークAPIにそのような値が提供されていないため、それができない.<br>
			Moaiでは、これに対処するため config.myf内に access_allow_ips, access_deny_ips 変数を導入し、<br>
			接続を許可/不許とするIP群を指定できるようにしている.<br>
			この設定については現状Web Configurationからは行えず、config.myfを直接編集する必要がある.<br>
			</li>
			<br>
			<li><b>server_name:</b><br>
			Web ConfigurationにおけるPOST先のホスト名として使われる.<br>
			acceptable_hostの値をLOOPBACK/ANYに変更した場合、この値が自動的に変更される場合がある.<br>
			</li>
			<br>
			<li><b>moai_port:</b><br>
			Moaiが使用する(リッスンする)ポート番号である.<br>
			</li>
		</ul>
	</div><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=plugin></a>
<u><b>
プラグイン機能について
</b></u><br>
<br>
<div class=MstyIndent>
	Moaiのプラグインでは現バージョンでは次のような拡張処理を実現できる.<br>
	<br>
	<ul>
		<li><b>initiate :</b><br>
		Web Configuration画面の「Virtual USERS Initiation」ボタンを押したときに呼び出される<br>
		マシン環境の仮想化およびランダマイズ化処理の実現.<br>
		</li>
		<br>
		<li><b>on_post :</b><br>
		POST時(レス投稿時など)に呼び出されて追加で実行される処理の実現.<br>
		これはさらなる高度なsend_filter処理をプログラミングで実現するための機構でもある.<br>
		</li>
		<br>
		<li><b>on_response :</b><br>
		リクエストに対する応答(例えば単純にHTMLにアクセスしてその内容を受信する場合など)に呼び出されて<br>
		追加で実行される処理の実現.<br>
		これはさらなる高度なrecv_filter処理をプログラミングで実現するための機構でもある.<br>
		</li>
	</ul>
	<br>
	pluginの実体はpluginsフォルダ内にある<b>TARGET_NAME</b>.dll(またはLinuxなどの場合<b>TARGET_NAME</b>.so)という<br>
	ファイルになる. これらの独自に作ってみたいというC言語プログラマの方は
	<a class=MstyElemLink href="/moai1.1/hacking.html">ハッキング</a>
	にそのヒントを記述しておいたので<br>
	興味があれば参照していただきたい.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=license></a>
<u><b>
ライセンス
</b></u><br>
<br>
<div class=MstyIndent>
	NYSL(煮るなり焼くなり好きにしろ)である.<br>
	( NYSLについては http://www.kmonos.net/nysl を参照. )<br>
	現時点での公式のソースリポジトリは https://github.com/mr-moai-2016/znk_project であるが<br>
	再配布はご自由にどうぞ.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<a name=as_is></a>
<u><b>
免責事項
</b></u><br>
<br>
<div class=MstyIndent>
	本ソフトウェアは「現状のまま」で、明示であるか暗黙であるかを問わず、<br>
	何らの保証もなく提供されます. 本ソフトウェアの使用によって生じるいかなる損害についても、<br>
	作者は一切の責任を負わないものとします.<br>
	<br>
	This software is provided 'as-is', without any express or implied warranty.<br>
	In no event will the authors be held liable for any damages arising<br>
	from the use of this software.<br>
	<br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b><br>
</div><br>
<br>


<u><b>リンク</b></u>
<ul>
	<li><a class=MstyElemLink href="#TopBar">一番上へ</a></li>
	<li><a class=MstyElemLink href="https://mr-moai-2016.github.io">Moaiドキュメント(オンライン)</a></li>
	<li><a class=MstyElemLink href="https://github.com/mr-moai-2016/znk_project">znk_project(github)</a></li>
</ul><br>

</body>
</html>
