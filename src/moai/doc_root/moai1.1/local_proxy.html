<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta http-equiv="Content-Style-Type" content="text/css">
	<link href="/msty.css" rel="stylesheet" type="text/css">
</head>
<body>
<a name=TopBar></a>
<p><b><img src="/imgs/here_landmark.png"> Moai1.1ドキュメント</b></p>

<a class=MstyElemLink href="/">トップページ</a> &nbsp;
<a class=MstyElemLink href="/moai2.0/index.html">Moai2.0ドキュメント</a> &nbsp;
<a class=MstyNowSelectedLink href="/moai1.1/index.html">Moai1.1ドキュメント</a> &nbsp;
<br> <br>
<a class=MstyElemLink        href="/moai1.1/install.html">インストールガイド</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/index.html">Moaiの特徴</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/moai_reference.html">Moaiリファレンス</a> &nbsp;
<a class=MstyNowSelectedLink href="/moai1.1/local_proxy.html">ローカルプロキシ</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/FAQ.html">FAQ</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/how_to_compile.html">HowToコンパイル</a> &nbsp;
<a class=MstyElemLink        href="/moai1.1/hacking.html">ハッキング</a> &nbsp;
<br> <br>

<div class=MstyComment>
<u><b>記事担当者</b></u> : Mr.Moai<br> 
<br>
<u><b>最終更新日</b></u> : 2018/03/25<br>
<br>
</div>
<br>


<a name=AtFirst></a>
<u><b>はじめに</b></u>
<ul>
	<font >
		この記事ではMoaiをローカルプロキシとして使用する方法について詳しく説明する.<br>
		この記事は主に古いバージョンのMoai Ver1.1.8向けのものである.<br>
		Moai Ver2.0以降でも、ここで説明された方法によりローカルプロキシによる仮想化を行うことは可能である.<br>
		(しかしVer2.0以降ではEasterによる仮想化が簡単に行えるため、<br>
		もはやローカルプロキシによる仮想化の意味はあまりない).
	</font><br>
</ul><br>


<a name=Index></a>
<u><b>目次</b></u>
<ul>
	<li><b><a class=MstyElemLink href=#WhatIsProxy>プロキシとは？</a></b></li>
	<li><b><a class=MstyElemLink href=#WhatIsLocalProxy>ローカルプロキシとは？</a></b></li>
	<li><b><a class=MstyElemLink href=#FirstLocalProxy>初めてのローカルプロキシ</a></b></li>
	<li><b><a class=MstyElemLink href=#WhatIsProxySettingDialog>プロキシ設定ダイアログとは？</a></b></li>
	<li><b><a class=MstyElemLink href=#warning>ご注意</a></b></li>
</ul><br>


<a name=WhatIsProxy></a>
<u><b>プロキシとは？</b></u>
<ul>
	<font >
		一般に「プロキシを使う」と言った場合、あなたと最終接続先となるホスト以外の第三者、<br>
		即ちプロキシサーバへと接続して通信を仲介させる.<br>
		概念的には以下のようになる.<br>
		<br>
		<div class=MstyComment>ブラウザ</div> ⇔
		<div class=MstyComment>外部サーバ上で動作するプロキシ</div> ⇔
		<div class=MstyComment>接続先サイト</div>
		<br>
		これにより、接続先サイトからはあなたのIPアドレスが隠蔽される.<br>
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>

<a name=WhatIsLocalProxy></a>
<u><b>ローカルプロキシとは？</b></u>
<ul>
	<font >
		ローカルプロキシとは第三者となる外部サーバで仲介するのではなく、<br>
		この仕事を文字通り今あなたの使っているコンピュータ上で行うというものである.<br>
		概念的には以下のようになる.<br>
		<br>
		<div class=MstyComment>ブラウザ</div> ⇔
		<div class=MstyComment>あなたのマシン上で動作するローカルプロキシ</div> ⇔
		<div class=MstyComment>接続先サイト</div>
		<br>
		お気づきだと思うが、ローカルプロキシがあくまであなたのマシンで動作している以上、<br>
		接続先サイトから見ればあなたのマシンからの通信となる. つまりIPアドレスは隠蔽されない.<br>
		ローカルプロキシを使う目的は IPアドレスを隠蔽することではないのだ.<br>
		<br> 
		では何のためにこれを間に挟むのか？<br>
		<br> 
		Moaiに限らず、一般にローカルプロキシは、あなたのブラウザとサイトとの通信を仲介する.<br>
		その主たる目的は、あなたが定義したフィルタに従って、その通信内容をフィルタリングすることである.<br>
		これによって特定の接続先サイトに送られるあなたのマシン固有の情報を遮断したり<br>
		偽装したりすることができる. つまりローカルプロキシとはプライベートを守るための<br>
		セキュリティーツールであり、それが本来の目的である.<br>
		<br>
		接続先サイトに送られるこの種の情報とは具体的にはUser-AgentなどのHTTPヘッダの内容、<br>
		POST時の変数の内容、Cookieの内容などである.<br>
		あなたが使っているブラウザには特にクリーンアップしない限りこの種の情報があちこちに残留している.<br>
		ローカルプロキシのフィルタリングはこれを遮断したり加工修正することで<br>
		接続先サイトにこれらがそのまま送信されることを防ぐ.<br>
		<div class=MstyComment>
		このフィルタリングの対象となるホストは細かく選択することもできる.<br>
		例えば www.moai-chan.net という掲示板があったとして、そのサイトとの通信を行う場合のみ<br>
		ある種のフィルタリングを行い、その他のサイトに関してはまた別のフィルタを使ったり<br>
		そもそもフィルタリングを行わないといった具合である.<br>
		</div>
		<br>
		また一方、受信においてサイトからの応答時のデータ(HTML, Javascriptのjsファイル, cssファイルなど)を<br>
		加工修正することもでき、これを応用することでページのレイアウトを好みの形に修正したり、<br>
		広告を除去したりすることができる. <br>
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>


<a name=FirstLocalProxy></a>
<u><b>初めてのローカルプロキシ</b></u>
<ul>
	<font >
		初めてMoaiをローカルプロキシとして使う場合は、以下の手順で設定しよう.<br>
		(ここでは既にMoaiをいつでも起動できる状態にしてあることを前提として話を進める.)<br>
		<br>
		<li>1. moaiを起動する.<br>
		</li>
		<br>
		<li>2. ブラウザの<a href=#WhatIsProxySettingDialog>プロキシ設定ダイアログ</a>でプロキシサーバとして localhost:8124 を指定する.<br>
		これでうまくいかない場合は 127.0.0.1:8124 で試してみよう! <br>
		</li>
		<div class=MstyComment>
		これは一般にループバック接続と呼ばれ、自分自身への接続を意味する.<br>
		リモートホストで起動しているMoaiに接続したい場合はそのIPを指定してもよい.
		</div>
		<br>
		基本的には以上である.<br>
		ブラウザから目的のサイトへアクセスできればOKである.<br>
		このとき<b>普通のURL</b>でそのまま目的のサイトにアクセスすればよい.<br>
		それがターゲットに設定されたサイトであれば自動的に仮想ブラウザ環境が実現される.<br>
		またターゲットに設定されていないサイトにアクセスする場合でも、すべての通信は根こそぎMoaiのローカルプロキシを経由して行われる.<br>
		そのためサイトによっては若干パフォーマンスが犠牲になることがあることをご了承いただきたい.<br>
		(Ver2.0以降で導入されたEasterはこの問題をも解消したものとなる)<br>
		<br>
		もし「プロキシサーバへの接続を拒否されました」のような表示がなされた場合は<br>
		おそらく 1 を起動していないか 2 の手順で何か指定をミスしている. <br>
		あるいはOSのファイアウォール機能により8124への接続がブロックされている可能性もあるので<br>
		その設定を確認してみよう. <br>
		<br>
		さらに http://127.0.0.1:8124 にアクセスし、Welcome to Moaiのページが表示されることも確認しよう.<br>
		特に新しくMoaiをダウンロードした直後、初めてのMoai起動時にはデフォルトの仮想ブラウザ環境の情報を変更しておいた方がよいだろう.<br>
		変更の仕方はMoaiのバージョンによって異なる.<br>
		<br>
		<br>
		<li><b>Moai Ver1.1.8の場合</b><br>
		VirtualUSERSはMoaiプラグインの一つになっており、<br>
		<a class=MstyElemLink href=http://localhost:8124/config>Moai Web Configuration</a>画面にある「Virtual USERS Initiation」ボタンを押すことにより、<br>
		仮想ブラウザ環境の情報を変更できる.<br>
		</li>
		<br>
		<li><b>Moai Ver2.0以降の場合</b><br>
		VirtualUSERSはMoai CGIアプリケーションの一つになっており、<br>
		<a class=MstyElemLink href=http://127.0.0.1:8124/cgis/custom_boy/custom_boy.cgi?cb_target=futaba&amp;cb_type=automatic>VirtualUSERS</a>画面にある「VirtualUSERS」ボタンを押すことにより、<br>
		仮想ブラウザ環境の情報を変更できる.<br>
		</li>
		<br>
		<!-- これについての詳細は[こちらも][2]ご覧いただきたい.<br -->
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>


<a name=WhatIsProxySettingDialog></a>
<u><b>プロキシ設定ダイアログとは？</b></u>
<ul>
	<font >
		プロキシを使ったことがある方なら、この項目を読む必要はない.<br>
		使ったことがない方でも、プロキシの設定方法に関してはググればいくらでも出てくるので<br>
		そちらをご覧頂いても勿論よいが、ここでも一応初心者の方向けにFirefoxを例にとり、<br>
		具体的な設定方法を概観する.<br>
		<br>
		<li>1. 「ツール」メニューから「オプション」を選び、例の色々設定できる画面を開く.
		</li><br>
		<li>2. 「詳細」タブを選び、そこにある「接続設定」ボタンを押す.
		</li><br>
		<li>3. 「インターネット接続」ダイアログ(下図)が出るので「手動でプロキシを設定する」<br>
		という部分にチェックをつける.
		</li><br>
		<li>4.  すぐ下にある「HTTPプロキシ」の部分に localhost (または127.0.0.1) と入力する.<br>
		また右隣にある「ポート」の部分に 8124 と入力する(このとき日本語入力はOFFにしておこう!)
		</li><br>
		<li>5.  同様にその下にある「SSLプロキシ」の部分に localhost (または127.0.0.1) と入力する.<br>
		また右隣にある「ポート」の部分に 8124 と入力する(このとき日本語入力はOFFにしておこう!)
		</li><br>
		<li>6.  moaiを起動する.  
		</li><br>
		以上である(先にmoaiを起動させておいてもよい).
		<br> <br>
		<img src=/imgs/screenshot_proxy_dialog.png>
		<br> <br>
		<div class=MstyComment>
		<u><b>【重要】</b></u><br> <br> 
		元の設定に戻す(プロキシを使用しない)方法も覚えておこう.<br>
		なぜこれが重要かといえば、本来<b>プロキシを使用しない</b>状態の方が自然だからである.<br>
		<br>
		上記 3. において「プロキシを使用しない」という項目が一番上にある.<br>
		これにチェックをつけることで、Firefoxはプロキシを介さない<b>通常の状態</b>に戻る.<br>
		(Firefoxの初期設定では元々この状態のはずである)<br>
		<br>
		もしmoaiの方が何か変なことになった場合(俗に言うバグった場合)は、一度moaiを終了して再び起動させれば<br>
		大抵の場合は問題は解消される. <br>
		<br>
		また万一、閲覧しているサイトがmoaiをローカルプロキシとして使用した場合においては、<br>
		どうしてもうまく表示されないなど不具合が発生する場合は、諦めてブラウザのプロキシ設定を元に戻した上で閲覧しよう.<br>
		Ver2.0以降ならEasterを使う方がほとんどの場合望ましい.
		</div>
		<br>
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>


<a name=warning></a>
<u><b>ご注意</b></u>
<ul>
	<font >
		Moaiは生まれたばかりのローカルプロキシです.<br>
		特に重要な内容を伴う情報の通信を確実に行う必要がある場合においては、<br>
		まず問題ないとは思うが、念のためMoaiの使用を一時中断するなどした方がよいかもしれない. <br>
		<br>
		また、このプログラムはポート番号8124においてクライアントからの接続をリッスンする.<br>
		(このデフォルトのポート番号はconfig.myfより変更することもできるが、その場合は<br>
		8124をその番号で読み替えて欲しい). <br>
		ここで言う「クライアント」とは、あなたのマシン、あるいは家庭内LANなど極めて小規模で<br>
		安全性が明らかなマシンにおいて、あなたの使うWebブラウザやその他のローカルプロキシなどのソフトなどのことである.<br>
		<br>
		仮に外部ネットワーク(WAN)からの不特定多数からの接続を許可した場合、<br>
		Moaiは一般的なプロキシサーバのソフトと同様の処理を行う. <br>
		しかしこのような用途での使用は基本的に想定されていないため、<br>
		WANからのIPアドレスの接続要求があった場合、それを許可してはならない. <br>
		(Squidなどのプロキシサーバ用の専用ソフトが行っている様々な防衛機構は、<br>
		Moaiではほとんど搭載されていないためである)<br>
		<br>
		よってあなたがルータの設定を特別弄くっていない限りは通常は心配いらないことであるが、<br>
		<b>acceptable_host</b>を<b>ANY</b>として、さらにルータやファイアウォールの8124ポートを開けているなど<br>
		WANからの接続を可能としたような<b>チャレンジャーな</b>使い方をされる予定なら、<br>
		Moai側での防御として<b>access_allow_ips</b> や<b>access_deny_ips</b> などで不要なIPからの接続要求を弾くなどし、<br>
		セキュリティ面にも十分配慮して欲しい.<br>
	</font><br>
	<b><a class=MstyElemLink href=#Index>目次に戻る</a></b>
</ul><br>


<u><b>リンク</b></u>
<ul>
	<li><a class=MstyElemLink href="#TopBar">一番上へ</a></li>
	<li><a class=MstyElemLink href="https://mr-moai-2016.github.io">Moaiドキュメント(オンライン)</a></li>
	<li><a class=MstyElemLink href="https://github.com/mr-moai-2016/znk_project">znk_project(github)</a></li>
</ul>

</body>
</html>
